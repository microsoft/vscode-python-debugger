# Run on a schedule
trigger: none
pr: none

schedules:
  - cron: '0 10 * * 1-5' # 10AM UTC (2AM PDT) MON-FRI (VS Code Pre-release builds at 9PM PDT)
    displayName: Nightly Pre-Release Schedule
    always: false # only run if there are source code changes
    branches:
      include:
        - main

resources:
  repositories:
    - repository: MicroBuildTemplate
      type: git
      name: 1ESPipelineTemplates/MicroBuildTemplate
      ref: refs/tags/release
variables:
  - name: TeamName
    value: VSCode-python-debugger
  - name: VsixName
    value: python-debugger.vsix
  - name: AZURE_ARTIFACTS_FEED
    value: 'https://devdiv.pkgs.visualstudio.com/DevDiv/_packaging/Pylance_PublicPackages/npm/registry/'
parameters:
  - name: publishExtension
    displayName: ðŸš€ Publish Extension
    type: boolean
    default: false

  - name: buildPlatforms
    type: object
    default:
      - name: Linux
        vsceTarget: ''
      - name: Linux
        packageArch: arm64
        vsceTarget: linux-arm64
      - name: Linux
        packageArch: arm
        vsceTarget: linux-armhf
      - name: Linux
        packageArch: x64
        vsceTarget: linux-x64
      - name: MacOS
        packageArch: arm64
        vsceTarget: darwin-arm64
      - name: MacOS
        packageArch: x64
        vsceTarget: darwin-x64
      - name: Windows
        packageArch: arm
        vsceTarget: win32-arm64
      - name: Windows
        packageArch: x64
        vsceTarget: win32-x64

  - name: buildSteps
    type: stepList
    default:
      - script: npm ci
        displayName: Install NPM dependencies

      - script: python -m pip install -U pip
        displayName: Upgrade pip

      - script: python -m pip install wheel
        displayName: Install wheel

      - script: python -m pip install nox
        displayName: Install nox

      - script: python -m nox --session install_bundled_libs
        displayName: Install Python dependencies

      - script: python ./build/update_ext_version.py --for-publishing
        displayName: Update build number

      - script: npm run package
        displayName: Build extension

extends:
  template: azure-pipelines/MicroBuild.1ES.Official.yml@MicroBuildTemplate
  parameters:
    sdl:
      sourceAnalysisPool: VSEngSS-MicroBuild2022-1ES
      codeSignValidation:
        enabled: true
      sbom:
        enabled: false # Disable global SBOM generation; we'll enable selectively per artifact output
    pool:
      name: AzurePipelines-EO
      os: windows

    customBuildTags:
      - ES365AIMigrationTooling
    stages:
      - stage: Build
        displayName: Build & Package Extension
        jobs:
          - template: build/templates/package.yml@self
            parameters:
              buildPlatforms: ${{ parameters.buildPlatforms }}
              buildSteps: ${{ parameters.buildSteps }}
              isPreRelease: true

      - stage: Sign
        displayName: Sign Extension
        dependsOn: Build
        jobs:
          - job: Sign
            displayName: Sign Job
            pool:
              name: VSEngSS-MicroBuild2022-1ES
              os: windows
            templateContext:
              mb:
                signing:
                  enabled: true
                  signType: real
                  signWithProd: true
              outputs:
                - output: pipelineArtifact
                  displayName: 'Publish Drop Artifact'
                  targetPath: '$(Build.StagingDirectory)\drop'
                  artifactName: drop
                  sbomEnabled: true
            steps:
              - download: current
                displayName: Download all build artifacts

              - template: build/templates/sign.yml@self
                parameters:
                  buildPlatforms: ${{ parameters.buildPlatforms }}
                  workingDirectory: $(Build.StagingDirectory)\drop
                  signType: real
                  verifySignature: true
                  teamName: $(TeamName)

              - ${{ if eq(parameters.publishExtension, true) }}:
                  - template: build/templates/publish.yml@self
                    parameters:
                      azureSubscription: PylancePublishPipelineSecureConnectionWithManagedIdentity
                      buildPlatforms: ${{ parameters.buildPlatforms }}
                      manifestName: extension.manifest
                      signatureName: extension.signature.p7s
                      publishFolder: drop
                      preRelease: true
