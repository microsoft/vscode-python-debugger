# DevDiv pipeline setup steps
parameters:
  - name: installNode
    type: boolean
    default: true
  - name: installPython
    type: boolean
    default: true
  - name: npmrcPath
    type: string
    default: '$(Build.SourcesDirectory)/.npmrc'

steps:
  - ${{ if eq(parameters.installNode, true) }}:
      - pwsh: |
          $npmrcPath = "${{ parameters.npmrcPath }}"

          if (Test-Path -LiteralPath $npmrcPath -PathType Container) {
            throw "npmrcPath points to a directory (expected a file): $npmrcPath"
          }

          $parent = Split-Path -Parent $npmrcPath
          if ($parent -and -not (Test-Path -LiteralPath $parent)) {
            New-Item -ItemType Directory -Path $parent -Force | Out-Null
          }

          if (-not (Test-Path -LiteralPath $npmrcPath -PathType Leaf)) {
            New-Item -ItemType File -Path $npmrcPath -Force | Out-Null
          }
        displayName: Ensure .npmrc is a file

      - task: npmAuthenticate@0
        inputs:
          workingFile: ${{ parameters.npmrcPath }}

      - pwsh: |
          $source = "${{ parameters.npmrcPath }}"
          $dest = "$(Build.SourcesDirectory)/.npmrc"

          if (-not (Test-Path -LiteralPath $source -PathType Leaf)) {
            throw "Expected authenticated .npmrc file at: $source"
          }

          if (Test-Path -LiteralPath $dest -PathType Container) {
            throw "Expected destination .npmrc to be a file, but it is a directory: $dest"
          }

          $srcFull = [System.IO.Path]::GetFullPath($source)
          $destFull = [System.IO.Path]::GetFullPath($dest)

          if ($srcFull -ieq $destFull) {
            Write-Host "Authenticated .npmrc already in repo root: $dest"
            return
          }

          if (-not (Test-Path -LiteralPath $dest -PathType Leaf)) {
            Copy-Item -LiteralPath $source -Destination $dest -Force
            Write-Host "Copied authenticated .npmrc -> $dest"
          } else {
            Write-Host "Repo root .npmrc already exists; not overwriting: $dest"
          }
        displayName: Copy .npmrc to repo root (if missing)

      - script: npm config get registry
        displayName: Verify NPM Registry

      - task: NodeTool@0
        inputs:
          versionSpec: '22.17.0'
          checkLatest: true
        displayName: Select Node 22 LTS

  - ${{ if eq(parameters.installPython, true) }}:
      - task: PipAuthenticate@1
        displayName: 'Pip Authenticate'
        inputs:
          artifactFeeds: 'DevDiv/debugpy'

      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.9' # note Install Python dependencies step below relies on Python 3.9
          addToPath: true
          architecture: 'x64'
        displayName: Select Python version
