# DevDiv pipeline setup steps
parameters:
  - name: installNode
    type: boolean
    default: true
  - name: installPython
    type: boolean
    default: true
  - name: customNPMRegistry
    type: string
    default: ''
  - name: nodeVersion
    type: string
    default: '22.17.0'
  - name: pythonVersion
    type: string
    default: '3.9'
  - name: npmrcPath
    type: string
    default: '$(Agent.TempDirectory)/.npmrc'

steps:
  - ${{ if eq(parameters.installNode, true) }}:
      - task: NodeTool@0
        inputs:
          versionSpec: ${{ parameters.nodeVersion }}
          checkLatest: true
        displayName: ðŸ›  Install Node ${{ parameters.nodeVersion }}

      - ${{ if ne(parameters.customNPMRegistry, '') }}:
          # When using a private/custom registry, configure npm to read auth/config from a temp user config
          # instead of relying on a checked-in project .npmrc.
          - pwsh: >
              & "$(Build.SourcesDirectory)/build/scripts/ensure-npm-userconfig.ps1"
              -Path "${{ parameters.npmrcPath }}"
              -Registry "${{ parameters.customNPMRegistry }}"
            displayName: ðŸ“¦ Setup NPM User Config

          # Configure npm/yarn to use the custom registry and ensure auth headers are sent.
          - pwsh: >
              & "$(Build.SourcesDirectory)/build/scripts/setup-npm-and-yarn.ps1"
              -NpmrcPath "${{ parameters.npmrcPath }}"
              -Registry "${{ parameters.customNPMRegistry }}"
            displayName: ðŸ“¦ Setup NPM & Yarn

          # Populate the temp .npmrc with auth for the configured registry.
          - task: npmAuthenticate@0
            inputs:
              workingFile: ${{ parameters.npmrcPath }}
            displayName: ðŸ“¦ Setup NPM Authentication

          # Ensure the registry always sends auth headers (npmAuthenticate may overwrite the file).
          - pwsh: >
              & "$(Build.SourcesDirectory)/build/scripts/finalize-npm-config.ps1"
              -Path "${{ parameters.npmrcPath }}"
            displayName: ðŸ“¦ Finalize NPM config

          # Some lockfiles contain hardcoded references to public registries. Rewrite them so installs
          # and `npx` resolve from the custom registry consistently.
          - pwsh: >
              & "$(Build.SourcesDirectory)/build/scripts/setup-npm-registry.ps1"
              -Registry "${{ parameters.customNPMRegistry }}"
            displayName: ðŸ“¦ Setup NPM Registry

      - script: npm config get registry
        displayName: Verify NPM Registry

  - ${{ if eq(parameters.installPython, true) }}:
      - task: PipAuthenticate@1
        displayName: 'Pip Authenticate'
        inputs:
          artifactFeeds: 'DevDiv/debugpy'

      - task: UsePythonVersion@0
        inputs:
          versionSpec: ${{ parameters.pythonVersion }}
          addToPath: true
          architecture: 'x64'
        displayName: Select Python ${{ parameters.pythonVersion }}
