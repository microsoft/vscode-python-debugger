# Template: Sign and validate VS Code extension artifacts
# Usage Example:
# - template: build/templates/sign.yml@self
#   parameters:
#     buildPlatforms: ${{ parameters.buildPlatforms }}
#     workingDirectory: $(Build.StagingDirectory)
#     signType: real
#
# Each platform gets its own subfolder to avoid filename collisions
# since all signed VSIX files are named the same (e.g., ms-python.debugpy.vsix)

parameters:
  - name: buildPlatforms
    type: object
    displayName: 'List of platforms to sign'
  - name: workingDirectory
    type: string
    default: '$(Build.StagingDirectory)'
  - name: signType
    type: string
    default: real
  - name: verifySignature
    type: boolean
    default: true
  - name: teamName
    type: string
    default: VSCode-python-debugger

steps:
  - powershell: |
      Write-Host "========================================"
      Write-Host "üîß Sign Template Parameters"
      Write-Host "========================================"
      Write-Host "Working Directory: ${{ parameters.workingDirectory }}"
      Write-Host "Sign Type: ${{ parameters.signType }}"
      Write-Host "Verify Signature: ${{ parameters.verifySignature }}"
      Write-Host "Team Name: ${{ parameters.teamName }}"
      Write-Host ""
      Write-Host "üìÇ Key Paths:"
      Write-Host "  Pipeline.Workspace: $(Pipeline.Workspace)"
      Write-Host "  Build.SourcesDirectory: $(Build.SourcesDirectory)"
      Write-Host "  Build.StagingDirectory: $(Build.StagingDirectory)"
      Write-Host "  Build.ArtifactStagingDirectory: $(Build.ArtifactStagingDirectory)"
      Write-Host ""
      Write-Host "üì¶ Available artifacts in Pipeline.Workspace:"
      Get-ChildItem "$(Pipeline.Workspace)" -Directory | ForEach-Object {
        Write-Host "  - $($_.Name)"
        Get-ChildItem $_.FullName -File | ForEach-Object { Write-Host "      $($_.Name) ($($_.Length) bytes)" }
      }
      Write-Host "========================================"
    displayName: 'üîç Log parameters and environment'

  - task: NuGetToolInstaller@1
    displayName: Install NuGet

  - task: NuGetCommand@2
    displayName: Restore signing packages
    inputs:
      command: restore
      feedsToUse: config
      restoreSolution: '$(Build.SourcesDirectory)/packages.config'
      restoreDirectory: '$(Build.SourcesDirectory)/packages'
      nugetConfigPath: '$(Build.SourcesDirectory)/build/NuGet.config'

  # Setup Node.js and npm authentication
  - template: setup.yml@self

  - task: Npm@1
    displayName: 'npm ci (install vsce)'
    inputs:
      command: ci
      workingDir: '$(Build.SourcesDirectory)'

  # ‚úÖ Enable MicroBuildSigningPlugin for PME enforcement (once for all platforms)
  - task: MicroBuildSigningPlugin@4
    displayName: Enable MicroBuild Signing
    inputs:
      signType: ${{ parameters.signType }}
      zipSources: false
      feedSource: 'https://devdiv.pkgs.visualstudio.com/DefaultCollection/_packaging/MicroBuildToolset/nuget/v3/index.json'
      ConnectedServiceName: 'MicroBuild Signing Task (DevDiv)'
      ConnectedPMEServiceName: 6cc74545-d7b9-4050-9dfa-ebefcc8961ea
    env:
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      TeamName: ${{ parameters.teamName }}

  # Process each platform in its own subfolder
  - ${{ each platform in parameters.buildPlatforms }}:
    - powershell: |
        Write-Host "========================================"
        Write-Host "üì¶ Setting up platform: ${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "========================================"
        
        $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "üìÅ Creating platform folder: $platformFolder"
        New-Item -ItemType Directory -Path $platformFolder -Force | Out-Null
        
        $artifactName = "vsix-${{ coalesce(platform.vsceTarget, 'universal') }}"
        $artifactPath = "$(Pipeline.Workspace)/$artifactName"
        Write-Host "üîç Looking for artifact at: $artifactPath"
        
        if (Test-Path $artifactPath) {
          Write-Host "‚úÖ Artifact folder found"
          Write-Host "üìÑ Files in artifact folder:"
          Get-ChildItem "$artifactPath" | ForEach-Object { Write-Host "  - $($_.Name) ($($_.Length) bytes)" }
          
          $vsixFiles = Get-ChildItem "$artifactPath/*.vsix"
          Write-Host "üì¶ Found $($vsixFiles.Count) VSIX file(s) to copy"
          
          foreach ($vsix in $vsixFiles) {
            Write-Host "  Copying: $($vsix.Name) -> $platformFolder"
            Copy-Item $vsix.FullName -Destination $platformFolder -Force
          }
          Write-Host "‚úÖ Copied VSIX for ${{ coalesce(platform.vsceTarget, 'universal') }}"
          
          # List what's in the platform folder
          Write-Host ""
          Write-Host "üìÇ Contents of platform folder:"
          Get-ChildItem $platformFolder | ForEach-Object { Write-Host "  - $($_.Name) ($($_.Length) bytes)" }
        } else {
          Write-Host "‚ùå Artifact folder not found: $artifactPath"
          Write-Host "üìÇ Contents of Pipeline.Workspace:"
          Get-ChildItem "$(Pipeline.Workspace)" | ForEach-Object { Write-Host "  - $($_.Name)" }
          Write-Error "Artifact folder not found: $artifactPath"
          exit 1
        }
        Write-Host "========================================"
      displayName: 'üìÅ Setup folder for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

    - powershell: |
        Write-Host "========================================"
        Write-Host "üìù Generating manifest for: ${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "========================================"
        
        $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "üìÇ Platform folder: $platformFolder"
        
        $vsixFiles = Get-ChildItem "$platformFolder/*.vsix" -ErrorAction SilentlyContinue
        if ($null -eq $vsixFiles -or $vsixFiles.Count -eq 0) {
          Write-Host "‚ùå No VSIX files found in platform folder"
          Get-ChildItem $platformFolder | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        # Check vsce installation
        $vscePath = "$(Build.SourcesDirectory)/node_modules/.bin/vsce.cmd"
        Write-Host "üîç Looking for vsce at: $vscePath"
        if (Test-Path $vscePath) {
          Write-Host "‚úÖ vsce found"
        } else {
          Write-Host "‚ùå vsce not found at $vscePath"
          Write-Host "üìÇ Contents of node_modules/.bin:"
          Get-ChildItem "$(Build.SourcesDirectory)/node_modules/.bin" -ErrorAction SilentlyContinue | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
        
        Write-Host "‚úÖ Found $($vsixFiles.Count) VSIX file(s)"
        foreach ($vsix in $vsixFiles) {
          $manifestPath = "$platformFolder/$($vsix.BaseName).manifest"
          Write-Host "üìù Generating manifest:"
          Write-Host "   Input:  $($vsix.FullName)"
          Write-Host "   Output: $manifestPath"
          
          Write-Host "üîÑ Running vsce generate-manifest..."
          $output = & $vscePath generate-manifest -i "$($vsix.FullName)" -o "$manifestPath" 2>&1
          $exitCode = $LASTEXITCODE
          Write-Host "   Output: $output"
          Write-Host "   Exit code: $exitCode"
          
          if ($exitCode -ne 0) {
            Write-Host "‚ùå vsce generate-manifest failed with exit code $exitCode"
            exit $exitCode
          }
          
          if (Test-Path $manifestPath) {
            Write-Host "‚úÖ Manifest created: $(Get-Item $manifestPath | Select-Object -ExpandProperty Length) bytes"
          } else {
            Write-Host "‚ùå Failed to create manifest file"
            exit 1
          }
        }
        Write-Host "========================================"
      displayName: 'üìù Generate manifest for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

    - powershell: |
        Write-Host "========================================"
        Write-Host "üîç Pre-sign inspection for: ${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "========================================"
        
        $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "üìÇ Platform folder: $platformFolder"
        Write-Host ""
        Write-Host "üìÑ Files:"
        Get-ChildItem $platformFolder | ForEach-Object {
          $icon = switch -Wildcard ($_.Extension) {
            ".vsix" { "üì¶" }
            ".manifest" { "üìù" }
            ".p7s" { "üîê" }
            default { "üìÑ" }
          }
          Write-Host "  $icon $($_.Name) ($($_.Length) bytes)"
        }
        
        $vsixCount = (Get-ChildItem "$platformFolder/*.vsix").Count
        $manifestCount = (Get-ChildItem "$platformFolder/*.manifest" -ErrorAction SilentlyContinue).Count
        Write-Host ""
        Write-Host "üìä Summary: $vsixCount VSIX, $manifestCount manifest(s)"
        
        if ($vsixCount -eq 0) { 
          Write-Host "‚ùå No VSIX files found"
          exit 1 
        }
        if ($manifestCount -eq 0) { 
          Write-Host "‚ùå No manifest files found"
          exit 1 
        }
        Write-Host "‚úÖ Ready for signing"
        Write-Host "========================================"
      displayName: 'üîç Pre-sign inspection for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

    - task: MSBuild@1
      displayName: 'üîè Sign ${{ coalesce(platform.vsceTarget, ''universal'') }}'
      inputs:
        solution: '$(Build.SourcesDirectory)/build/sign.proj'
        msbuildArguments: >
          /verbosity:detailed
          /bl:"${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}/signing.binlog"
          /p:SignType=${{ parameters.signType }}
          /p:BaseOutputDirectory=${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}
          /p:OutDir=${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}
          /p:IntermediateOutputPath=${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}/intermediate

    - powershell: |
        Write-Host "========================================"
        Write-Host "üîç Post-sign inspection for: ${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "========================================"
        
        $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "üìÇ Platform folder: $platformFolder"
        Write-Host ""
        Write-Host "üìÑ Files after signing:"
        Get-ChildItem $platformFolder -File | ForEach-Object {
          $icon = switch -Wildcard ($_.Extension) {
            ".vsix" { "üì¶" }
            ".manifest" { "üìù" }
            ".p7s" { "üîê" }
            ".binlog" { "üìã" }
            default { "üìÑ" }
          }
          Write-Host "  $icon $($_.Name) ($($_.Length) bytes)"
        }
        
        $vsixCount = (Get-ChildItem "$platformFolder/*.vsix").Count
        $manifestCount = (Get-ChildItem "$platformFolder/*.manifest" -ErrorAction SilentlyContinue).Count
        $p7sCount = (Get-ChildItem "$platformFolder/*.p7s" -ErrorAction SilentlyContinue).Count
        Write-Host ""
        Write-Host "üìä Summary: $vsixCount VSIX, $manifestCount manifest(s), $p7sCount signature(s)"
        
        if ($p7sCount -gt 0) {
          Write-Host "‚úÖ Signature files found"
        } else {
          Write-Host "‚ö†Ô∏è No signature files found after signing"
        }
        Write-Host "========================================"
      displayName: 'üîç Post-sign inspection for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

    - powershell: |
        Write-Host "========================================"
        Write-Host "‚úÖ Validating signature for: ${{ coalesce(platform.vsceTarget, 'universal') }}"
        Write-Host "========================================"
        
        $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
        $vsixFiles = Get-ChildItem "$platformFolder/*.vsix"
        
        foreach ($vsix in $vsixFiles) {
          Write-Host "üì¶ Validating: $($vsix.Name)"
          $manifestPath = "$platformFolder/$($vsix.BaseName).manifest"
          $signaturePath = "$platformFolder/$($vsix.BaseName).signature.p7s"
          
          Write-Host "   Manifest:  $manifestPath"
          Write-Host "   Signature: $signaturePath"
          
          if (!(Test-Path $manifestPath)) { 
            Write-Host "‚ùå Manifest missing"
            exit 1 
          }
          if (!(Test-Path $signaturePath)) { 
            Write-Host "‚ùå Signature missing"
            exit 1 
          }
          
          $manifestHash = (Get-FileHash -Algorithm SHA256 $manifestPath).Hash
          $signatureHash = (Get-FileHash -Algorithm SHA256 $signaturePath).Hash
          Write-Host "   Manifest SHA256:  $manifestHash"
          Write-Host "   Signature SHA256: $signatureHash"
          
          if ($manifestHash -eq $signatureHash) {
            Write-Host "‚ùå Signature file is identical to manifest (placeholder detected)"
            exit 1
          } else {
            Write-Host "‚úÖ Hashes differ - signature is valid"
          }
        }
        Write-Host "========================================"
      displayName: '‚úÖ Validate signature for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

    - ${{ if eq(parameters.verifySignature, true) }}:
        - powershell: |
            Write-Host "========================================"
            Write-Host "üîê Verifying signature for: ${{ coalesce(platform.vsceTarget, 'universal') }}"
            Write-Host "========================================"
            
            $platformFolder = "${{ parameters.workingDirectory }}/${{ coalesce(platform.vsceTarget, 'universal') }}"
            $vsixFiles = Get-ChildItem "$platformFolder/*.vsix"
            
            foreach ($vsix in $vsixFiles) {
              Write-Host "üì¶ Verifying: $($vsix.Name)"
              $manifestPath = "$platformFolder/$($vsix.BaseName).manifest"
              $signaturePath = "$platformFolder/$($vsix.BaseName).signature.p7s"
              
              Write-Host "   Package:   $($vsix.FullName)"
              Write-Host "   Manifest:  $manifestPath"
              Write-Host "   Signature: $signaturePath"
              
              if (!(Test-Path $vsix.FullName)) { Write-Host "‚ùå Missing VSIX"; exit 1 }
              if (!(Test-Path $manifestPath)) { Write-Host "‚ùå Missing manifest"; exit 1 }
              if (!(Test-Path $signaturePath)) { Write-Host "‚ùå Missing signature"; exit 1 }
              
              Write-Host "üîÑ Running vsce verify-signature..."
              & "$(Build.SourcesDirectory)/node_modules/.bin/vsce" verify-signature --packagePath "$($vsix.FullName)" --manifestPath "$manifestPath" --signaturePath "$signaturePath"
              
              if ($LASTEXITCODE -ne 0) {
                Write-Host "‚ùå vsce verify-signature failed with exit code $LASTEXITCODE"
                exit $LASTEXITCODE
              } else {
                Write-Host "‚úÖ Signature verification succeeded"
              }
            }
            Write-Host "========================================"
          displayName: 'üîê Verify signature for ${{ coalesce(platform.vsceTarget, ''universal'') }}'

  # Final summary of all signed artifacts
  - powershell: |
      Write-Host "========================================"
      Write-Host "üìä Final Summary - All Signed Platforms"
      Write-Host "========================================"
      
      $baseDir = "${{ parameters.workingDirectory }}"
      $platformFolders = Get-ChildItem $baseDir -Directory
      
      foreach ($folder in $platformFolders) {
        Write-Host ""
        Write-Host "üìÅ Platform: $($folder.Name)"
        $vsixFiles = Get-ChildItem "$($folder.FullName)/*.vsix" -ErrorAction SilentlyContinue
        $p7sFiles = Get-ChildItem "$($folder.FullName)/*.p7s" -ErrorAction SilentlyContinue
        
        if ($vsixFiles) {
          foreach ($vsix in $vsixFiles) {
            $hasSig = Test-Path "$($folder.FullName)/$($vsix.BaseName).signature.p7s"
            $status = if ($hasSig) { "‚úÖ Signed" } else { "‚ùå Not signed" }
            Write-Host "   üì¶ $($vsix.Name) - $status"
          }
        } else {
          Write-Host "   ‚ö†Ô∏è No VSIX files found"
        }
      }
      Write-Host ""
      Write-Host "========================================"
    displayName: 'üìä Final summary'
